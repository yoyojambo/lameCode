<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>LameCode - {{ .Problem.Title }}</title>
  <!-- Minimal CSS (Skeleton) -->
  <link rel="stylesheet" href="/assets/custom.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.min.css">
  <script src="https://cdn.jsdelivr.net/npm/htmx.org@1.9.2"></script>
  <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs/loader.js"></script>
</head>
<body>
  {{template "navbar"}}

  <!-- Main Content -->
  <div id="main" class="container">
	{{block "problem" .}}
    <div class="row">
      <!-- Left Column: Problem Details -->
      <div class="six columns box">
        <h3>{{ .Problem.Title }}</h3>
        {{/* Difficulty label logic */}}
        {{ if eq .Problem.Difficulty 1 }}
        <span class="difficulty easy">Easy</span>
        {{ else if eq .Problem.Difficulty 2 }}
        <span class="difficulty medium">Medium</span>
        {{ else if eq .Problem.Difficulty 3 }}
        <span class="difficulty hard">Hard</span>
        {{ else }}
        <span class="difficulty">Not tagged</span>
        {{ end }}

        <!-- Problem description is rendered as HTML -->
        <div id="problem-description">
          {{ .Problem.Description }}
        </div>
      </div>

      <!-- Right Column: Code Editor and Results -->

      <div class="six columns box" style="margin-left: 1%">
		<div class="editor-container">
		  <div class="editor-top-bar">
			<select id="language-select" name="language">
			  <option value="go">Go</option>
			  <option value="python">Python</option>
			  <option value="javascript">JavaScript</option>
			</select>
			<button id="reset-button" type="button">Reset</button>
		  </div>

		  <div id="code-editor"></div>
		  <textarea id="code-input" name="code" hidden></textarea>

		  <div class="editor-bottom-bar">
			<button id="test-button"
					hx-post="/judge/test"
					hx-include="#code-input,#language-select"
					hx-target="#results"
					hx-swap="innerHTML"
					hx-indicator=".spinner"
					type="button"
					onclick="document.getElementById('code-input').value = window.editor.getValue()"
					>Test</button>

			<button id="submit-button"
					hx-post="/judge/submit"
					hx-include="#code-input,#language-select"
					hx-target="#submission-modal .modal-content p"
					hx-swap="innerHTML"
					hx-indicator=".spinner"
					type="button"
					onclick="document.getElementById('code-input').value = window.editor.getValue()"
					>Submit</button>

			<div class="spinner">⏳</div>
		  </div>

		  <div id="results" class="results">No results yet.</div>
		</div>
	  </div>

      <div id="submission-modal" class="modal" style="display:none">
		<div class="modal-content">
		  <span class="close" onclick="document.getElementById('submission-modal').style.display='none'">&times;</span>
		  <p>Your code has been submitted. We’ll let you know the results soon!</p>
		</div>
      </div>

    </div>
      {{end}}
  </div>

  <script>
    require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.47.0/min/vs' } });
    require(['vs/editor/editor.main'], function() {
	window.editor = monaco.editor.create(
	    document.getElementById('code-editor'), {
		value: "// Your code here",
		language: 'go',
		automaticLayout: true
	    }
	);

	// Later there could be better initial code given, that parses input for instance.
	{{if .InitialCode}}
	{{else}}
	resetLanguage()
	{{end}}
    });

    
    const defaultSnippets = {
	go: `package main

func main() {
    // your Go solution here
}
`,
	python: `def main():
    # your Python solution here

if __name__ == "__main__":
    main()
`,
	javascript: `function main() {
    // your JS solution here
}

main();
`
    };

    const resetLanguage = () => {
	const lang = languageSelect.value;
	monaco.editor.setModelLanguage(editor.getModel(), lang);
	editor.setValue(defaultSnippets[lang] || '');
    }

    const languageSelect = document.getElementById('language-select');
    languageSelect.addEventListener('change', resetLanguage);

    // also update your Reset button to use the map:
    document.getElementById('reset-button').addEventListener('click', () => {
	const lang = languageSelect.value;
	editor.setValue(defaultSnippets[lang] || '');
    });

    document.getElementById('reset-button').addEventListener('click', resetLanguage);

    document.body.addEventListener('htmx:afterSwap', function(evt) {
	if (evt.detail.target.id === 'results') {
	    evt.detail.target.scrollTop = 0;
	}
    });
  </script>
</body>
</html>
